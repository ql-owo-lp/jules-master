name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.1"

      - name: Run Backend Tests
        run: make test-backend

  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install Dependencies
        working-directory: ./ui
        run: npm ci

      - name: Run Unit Tests
        working-directory: ./ui
        run: npm run test:unit

  e2e:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Production Image
      - name: Build Production Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: nextn-app:latest

      # Build Test Runner Image (reusing Dockerfile.test)
      - name: Build Test Runner Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./ui/Dockerfile.test
          push: false
          load: true
          tags: jules-test:latest

      # Start Production App with Shared Volume
      - name: Start Production App
        run: |
          docker volume create shared-data
          # Run production app with shared volume for DB
          docker run -d \
            --name nextn-prod \
            --network host \
            -e PORT=9002 \
            -e DATABASE_URL=/app/data/sqlite.db \
            -v shared-data:/app/data \
            nextn-app:latest

          # Initial wait for container
          sleep 5

      # Run Tests
      - name: Run E2E Tests
        run: |
          # 1. Seed the DB using the test runner (mounting the same volume)
          # We use the test runner because it has the tsx/scripts needed for seeding
          docker run --rm \
            --network host \
            -v shared-data:/app/data \
            -e DATABASE_URL=/app/data/sqlite.db \
            --entrypoint /bin/sh \
            jules-test:latest \
            -c "npx tsx scripts/seed-e2e.ts"

          # 2. Run Playwright Tests against network host (localhost:9002)
          docker run --rm \
            --network host \
            -e TEST_TARGET_URL=http://localhost:9002 \
            -e TEST_SKIP_WEBSERVER=true \
            -e CI=true \
            jules-test:latest \
            npm run test:e2e

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ui/playwright-report/
          retention-days: 30

  comment-on-failure:
    runs-on: ubuntu-latest
    needs: [backend-test, test, e2e]
    if: failure() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const needs = ${{ toJson(needs) }};
            const { repo, owner } = context.repo;
            const run_id = context.runId;
            const run_url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;

            const failedJobs = Object.entries(needs)
              .filter(([_, job]) => job.result === 'failure')
              .map(([name]) => name);

            const list = failedJobs.map(job => `- **${job}**`).join('\n');

            const body = `‚ùå **CI Checks Failed** @jules

            The following checks failed in this run:
            ${list}

            Please check the [Action logs](${run_url}) for more details.
            `;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.issue.number,
              body
            });
