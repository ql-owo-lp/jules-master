# Copyright 2026 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

name: Delete Stale Branches

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:

jobs:
  delete-stale-branches:
    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install gh CLI
        run: |
          install_dependencies() {
            if ! command -v curl &> /dev/null; then
              echo "curl not found. Installing..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y curl ca-certificates
              elif command -v apk &> /dev/null; then
                sudo apk add --no-cache curl ca-certificates
              elif command -v yum &> /dev/null; then
                sudo yum install -y curl ca-certificates
              elif command -v dnf &> /dev/null; then
                sudo dnf install -y curl ca-certificates
              else
                echo "Could not find package manager to install curl. Trying to proceed..."
              fi
            fi
          }

          if ! command -v gh &> /dev/null; then
            echo "gh not found. Installing..."
            install_dependencies

            GH_VERSION="2.65.0"
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH_STR="amd64" ;;
              aarch64) ARCH_STR="arm64" ;;
              *) echo "Unsupported arch: $ARCH"; exit 1 ;;
            esac

            mkdir -p /tmp/gh-install
            if command -v curl &> /dev/null; then
              curl -fsSL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH_STR}.tar.gz | tar xz -C /tmp/gh-install
            elif command -v wget &> /dev/null; then
              wget -qO- https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH_STR}.tar.gz | tar xz -C /tmp/gh-install
            else
              echo "Neither curl nor wget found. Cannot install gh."
              exit 1
            fi

            BIN_PATH="/tmp/gh-install/gh_${GH_VERSION}_linux_${ARCH_STR}/bin/gh"

            if [ -w /usr/local/bin ]; then
               cp "$BIN_PATH" /usr/local/bin/
            elif command -v sudo &> /dev/null; then
               sudo cp "$BIN_PATH" /usr/local/bin/
            else
               mkdir -p "$HOME/.local/bin"
               cp "$BIN_PATH" "$HOME/.local/bin/"
               echo "$HOME/.local/bin" >> $GITHUB_PATH
            fi

            rm -rf /tmp/gh-install
            echo "gh installed successfully."
          else
            echo "gh is already installed."
          fi

      - name: Close Stale PRs
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          DAYS_THRESHOLD=3
          # Calculate date threshold in YYYY-MM-DD for gh search
          DATE_THRESHOLD=$(date -d "$DAYS_THRESHOLD days ago" +%Y-%m-%d)

          echo "Closing PRs updated before $DATE_THRESHOLD..."

          # Find open PRs updated before the threshold
          gh pr list \
            --repo ${{ github.repository }} \
            --search "state:open updated:<$DATE_THRESHOLD" \
            --json number,updatedAt,url \
            --jq '.[] | .number' | \
          while read pr_number; do
            echo "Closing stale PR #$pr_number"
            gh pr comment $pr_number --repo ${{ github.repository }} --body "ðŸ¤– **Automated Cleanup:** This PR has been inactive for more than $DAYS_THRESHOLD days. Closing it now."
            gh pr close $pr_number --repo ${{ github.repository }}
          done

      - name: Delete Stale Branches
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          # Configuration
          DAYS_THRESHOLD=3
          EXCLUDED_BRANCHES=("main" "master" "develop" "staging" "HEAD")

          # Calculate cutoff date in seconds
          CUTOFF_DATE=$(date -d "$DAYS_THRESHOLD days ago" +%s)

          echo "Cleaning up branches older than $DAYS_THRESHOLD days (before $(date -d @$CUTOFF_DATE))..."

          # Iterate over remote branches
          # git for-each-ref returns "origin/branchname commit-date-iso"
          git for-each-ref --format='%(refname:short) %(committerdate:unix)' refs/remotes/origin/ | while read full_ref commit_date; do
            # Remove 'origin/' prefix
            branch_name=${full_ref#origin/}

            # Check if excluded
            skip=false
            for excluded in "${EXCLUDED_BRANCHES[@]}"; do
              if [[ "$branch_name" == "$excluded" ]]; then
                skip=true
                break
              fi
            done

            if [[ "$skip" == "true" ]]; then
              echo "Skipping excluded branch: $branch_name"
              continue
            fi

            # Check for open PRs associated with this branch (optional safety check)
            # If there is an open PR, we probably shouldn't delete the branch yet even if stale?
            # User said "automatically delete stale branch after 3 days". Usually stale means "no activity".
            # If an open PR exists but no activity for 3 days, should it be deleted?
            # Let's assume yes, or maybe check if it's draft?
            # To be safe, let's ONLY check the date for now as requested.

            # Check for open PRs associated with this branch first
            # We use the head branch name to find PRs
            pr_info=$(gh pr list \
              --repo ${{ github.repository }} \
              --head "$branch_name" \
              --state open \
              --json number,updatedAt,isDraft \
              --jq '.[0]')

            if [[ -n "$pr_info" && "$pr_info" != "null" ]]; then
              pr_number=$(echo "$pr_info" | jq -r '.number')
              pr_updated_at=$(echo "$pr_info" | jq -r '.updatedAt')
              pr_is_draft=$(echo "$pr_info" | jq -r '.isDraft')

              # Convert PR updated date to seconds
              pr_updated_sec=$(date -d "$pr_updated_at" +%s)

              if [[ "$pr_is_draft" == "true" ]]; then
                echo "Skipping branch $branch_name: Associated PR #$pr_number is a draft."
                continue
              elif [[ $pr_updated_sec -ge $CUTOFF_DATE ]]; then
                echo "Skipping branch $branch_name: Associated PR #$pr_number was updated recently ($(date -d @$pr_updated_sec))."
                continue
              else
                 echo "Processing stale branch: $branch_name (Last commit: $(date -d @$commit_date), PR updated: $(date -d @$pr_updated_sec))"
                 echo "Closing stale PR #$pr_number associated with branch $branch_name"
                 gh pr close "$pr_number" \
                   --repo ${{ github.repository }} \
                   --comment "ðŸ¤– **Automated Cleanup:** Closing stale PR associated with stale branch."
                 
                 # Delete branch
                 git push origin --delete "$branch_name" || echo "Failed to delete $branch_name"
              fi
            elif [[ $commit_date -lt $CUTOFF_DATE ]]; then
              echo "Processing stale branch: $branch_name (Last commit: $(date -d @$commit_date))"
              # Delete branch
              git push origin --delete "$branch_name" || echo "Failed to delete $branch_name"
            else
              echo "Keeping active branch: $branch_name (Last commit: $(date -d @$commit_date))"
            fi
          done