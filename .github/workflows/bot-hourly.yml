# Copyright 2026 Author(s) of MCP Any
# SPDX-License-Identifier: Apache-2.0

name: Manage PRs (Merge & Cleanup)

on:
  schedule:
    - cron: '*/10 * * * *' # Runs every 10 minutes
  workflow_dispatch: # Allows manual triggering

jobs:
  manage-prs:
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install gh CLI
        run: |
          install_dependencies() {
            if ! command -v curl &> /dev/null; then
              echo "curl not found. Installing..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y curl ca-certificates
              elif command -v apk &> /dev/null; then
                sudo apk add --no-cache curl ca-certificates
              elif command -v yum &> /dev/null; then
                sudo yum install -y curl ca-certificates
              elif command -v dnf &> /dev/null; then
                sudo dnf install -y curl ca-certificates
              else
                echo "Could not find package manager to install curl. Trying to proceed..."
              fi
            fi
          }

          if ! command -v gh &> /dev/null; then
            echo "gh not found. Installing..."
            install_dependencies

            GH_VERSION="2.65.0"
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH_STR="amd64" ;;
              aarch64) ARCH_STR="arm64" ;;
              *) echo "Unsupported arch: $ARCH"; exit 1 ;;
            esac

            mkdir -p /tmp/gh-install
            if command -v curl &> /dev/null; then
              curl -fsSL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH_STR}.tar.gz | tar xz -C /tmp/gh-install
            elif command -v wget &> /dev/null; then
              wget -qO- https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${ARCH_STR}.tar.gz | tar xz -C /tmp/gh-install
            else
              echo "Neither curl nor wget found. Cannot install gh."
              exit 1
            fi

            BIN_PATH="/tmp/gh-install/gh_${GH_VERSION}_linux_${ARCH_STR}/bin/gh"

            if [ -w /usr/local/bin ]; then
               cp "$BIN_PATH" /usr/local/bin/
            elif command -v sudo &> /dev/null; then
               sudo cp "$BIN_PATH" /usr/local/bin/
            else
               mkdir -p "$HOME/.local/bin"
               cp "$BIN_PATH" "$HOME/.local/bin/"
               echo "$HOME/.local/bin" >> $GITHUB_PATH
            fi

            rm -rf /tmp/gh-install
            echo "gh installed successfully."
          else
            echo "gh is already installed."
          fi

      # Step 1: Merge PRs that are passing and ready
      - name: Merge Passing PRs
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          # Find PRs that are open, passing CI, and have no merge conflicts
          gh pr list \
            --repo ${{ github.repository }} \
            --base main \
            --sort updated \
            --order desc \
            --search "is:pr is:open author:@me" \
            --json number \
            --jq '.[].number' | \
          while read pr_number; do
            echo "Processing PR #$pr_number..."

            # Retry mechanism
            max_retries=2
            retry_count=0
            success=false

            while [ $retry_count -lt $max_retries ]; do
              if gh pr merge $pr_number --squash --repo ${{ github.repository }}; then
                success=true
                echo "Successfully merged PR #$pr_number"
                break
              else
                echo "Failed to merge PR #$pr_number (Attempt $((retry_count+1))/$max_retries)"
                retry_count=$((retry_count+1))
                sleep 5 # Wait a bit before retrying
              fi
            done

            if [ "$success" = false ]; then
              echo "Could not merge PR #$pr_number after $max_retries attempts. Closing it."
              gh pr comment $pr_number --repo ${{ github.repository }} --body "ðŸ¤– **Automated Cleanup:** This PR has merge conflicts. Please resolve them locally and reopen or open a new PR."
              gh pr close $pr_number --repo ${{ github.repository }}
            fi
          done